import logging
import pandas as pd
import sqlite3 
import pyodbc 
import os
import openpyxl

logging.basicConfig(filename='LOG.log', format='%(asctime)s %(message)s', datefmt='%Y%m%d %H:%M:%S %p', level=logging.DEBUG)


##ruta = (r'C:\\Users\\dbarco\\Documents\\Prueba Tecnica DP 2\\Prueba-tecnica-DP-2') para el config

################### AGREGAR HOJA DE EXCEL A BASE DE DATOS DE MS ACCES #################
## Abrir el archivo de excel con openpy para crear las tuplas que irán en la tabla de access
excel =  openpyxl.load_workbook(r'C:\\Users\\dbarco\\Documents\\Prueba Tecnica DP 2\\Prueba-tecnica-DP-2\\CATALOGO_CLASE.xlsx')
tabla = 'CATALOGO_CLASE'    ##Nombre que tendra la tabla en la base de datos
hoja_activa = excel.active

### Se realiza la concexión con MS ACCESS con el modulo pyodc
##   print(driver) -Para ver los Drivers
conn_string = (r'Driver={Microsoft Access Driver (*.mdb, *.accdb)};'
              r'DBQ= C:\\Users\\dbarco\\Documents\\Prueba Tecnica DP 2\\Prueba-tecnica-DP-2\\bases_datos.accdb;')
conn = pyodbc.connect(conn_string)
cursor = conn.cursor()

logging.debug('Se ha realizado la conexión con la base de datos de MS ACCESS')


## Se crea la funcion que permite guardar los datos del archivo de excel como tuplas
datos_excel = []

for fila in hoja_activa.iter_rows(values_only = True):
    datos_excel.append(fila)
excel.close()

## se crea la tabla y se agrega el nombre de las columnas
sql_crear_tabla = f"CREATE TABLE {tabla} ("  
nombres_columnas = datos_excel[0]
for nombre_columna in nombres_columnas:
    sql_crear_tabla+= f"{nombre_columna} TEXT,"
sql_crear_tabla = sql_crear_tabla.rstrip(',')
sql_crear_tabla+= ')'
cursor.execute(sql_crear_tabla)
logging.debug('Se ha creado la tabla con el nombre CATALOGO_CLASE')

## Insertar los datos apartir de las segunda fila en la tabla creada
sql_insertar = f"INSERT INTO {tabla} VALUES ("
for fila_datos in datos_excel[1:]:
    valores_fila = ",".join([f"'{valor}'" for valor in fila_datos])
    cursor.execute(f"{sql_insertar}{valores_fila})")
conn.commit()
logging.debug('Se han insertado los datos a la tabla')






## Conocer el nombre de las tablas almacenadas en el archivo de Access
for nombre in cursor.tables(tableType='TABLE'):
    print (nombre.table_name)

##with open('C:\\Users\\dbarco\\Documents\\Prueba Tecnica DP 2\\Prueba-tecnica-DP-2\\Prueba.sql','r') as file:
##  sql_script = file.read()
## cursor.execute(sql_script)

##cursor.execute("""SELECT * from Clientes where ciudad_residencia = 'BOGOTA D.C.' """)
##rows = cursor.fetchone()
##print(rows)

##conn.close()




##with open('C:\\Users\dbarco\Documents\\Prueba Tecnica DP 2\\Prueba-tecnica-DP-2\\Prueba.sql','r') as qr:
  ##  query = qr.read()
##cursor.execute(query)















